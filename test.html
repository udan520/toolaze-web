<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Toolaze Logic Tester</title>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; max-width: 600px; margin: 40px auto; padding: 20px; background: #f0f4f8; }
        .card { background: white; padding: 30px; border-radius: 16px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; }
        .upload-box { border: 2px dashed #cbd5e1; padding: 40px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .upload-box:hover { border-color: #6366f1; background: #eef2ff; }
        select, button { padding: 10px 20px; font-size: 16px; border-radius: 8px; margin-top: 20px; }
        button { background: #6366f1; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #4f46e5; }
        #results { margin-top: 30px; text-align: left; }
        .item { background: #f8fafc; padding: 15px; border: 1px solid #e2e8f0; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .tag { background: #dcfce7; color: #166534; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        a { color: #6366f1; text-decoration: none; font-weight: bold; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸ§© Toolaze é€»è¾‘éªŒè¯å™¨</h2>
    <p style="color: #64748b; font-size: 14px;">ä¸ä¾èµ– Reactï¼Œç›´æ¥æµ‹è¯• Canvas è½¬æ¢æ ¸å¿ƒç®—æ³•</p>
    
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
        <p>ç‚¹å‡»é€‰æ‹©å›¾ç‰‡ (æ”¯æŒå¤šé€‰)</p>
        <input type="file" id="fileInput" multiple accept="image/*" style="display:none">
    </div>

    <div id="controls" style="display:none;">
        <select id="formatSelect">
            <option value="image/jpeg">è½¬ä¸º JPG (æµ‹è¯•ç™½åº•å¡«å……)</option>
            <option value="image/png">è½¬ä¸º PNG</option>
            <option value="image/webp">è½¬ä¸º WEBP</option>
            <option value="image/bmp">è½¬ä¸º BMP</option>
        </select>
        <button onclick="processFiles()">å¼€å§‹è½¬æ¢æµ‹è¯•</button>
    </div>

    <div id="results"></div>
</div>

<script>
    let selectedFiles = [];
    const fileInput = document.getElementById('fileInput');
    const controls = document.getElementById('controls');
    const resultsDiv = document.getElementById('results');

    // ç›‘å¬æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', (e) => {
        selectedFiles = Array.from(e.target.files);
        if (selectedFiles.length > 0) {
            controls.style.display = 'block';
            resultsDiv.innerHTML = `<p style="color:#64748b">å·²é€‰æ‹© ${selectedFiles.length} å¼ å›¾ç‰‡ï¼Œè¯·ç‚¹å‡»è½¬æ¢...</p>`;
        }
    });

    // --- æ ¸å¿ƒé€»è¾‘ (ä¸ React ç‰ˆå®Œå…¨ä¸€è‡´) ---
    async function processFiles() {
        const targetMime = document.getElementById('formatSelect').value;
        const targetExt = targetMime.split('/')[1].replace('jpeg', 'jpg');
        
        resultsDiv.innerHTML = ''; // æ¸…ç©ºç»“æœ

        for (const file of selectedFiles) {
            try {
                // 1. è¯»å–å¹¶è½¬æ¢
                const dataUrl = await convertToFormat(file, targetMime);
                
                // 2. ä¼°ç®—å¤§å°
                const sizeKB = Math.round((dataUrl.length * 3 / 4) / 1024);
                
                // 3. æ˜¾ç¤ºç»“æœ
                const div = document.createElement('div');
                div.className = 'item';
                div.innerHTML = `
                    <div>
                        <strong>${file.name}</strong> <br>
                        <span style="font-size:12px; color:#94a3b8">-> ${sizeKB} KB (${targetExt.toUpperCase()})</span>
                    </div>
                    <a href="${dataUrl}" download="test-${file.name.split('.')[0]}.${targetExt}">ä¸‹è½½éªŒè¯</a>
                `;
                resultsDiv.appendChild(div);

            } catch (err) {
                console.error(err);
                alert('è½¬æ¢å¤±è´¥: ' + file.name);
            }
        }
    }

    // --- Canvas å¼•æ“ (æ ¸å¿ƒç®—æ³•) ---
    function convertToFormat(file, targetMime) {
        return new Promise((resolve, reject) => {
            const img = new Image();
            const reader = new FileReader();

            reader.onload = (e) => { img.src = e.target.result; };
            
            img.onload = () => {
                const canvas = document.createElement('canvas');
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext('2d');

                // ğŸ”¥ å…³é”®éªŒè¯ç‚¹ï¼šé€æ˜åº¦å¤„ç† ğŸ”¥
                // å¦‚æœç›®æ ‡æ˜¯ JPG æˆ– BMPï¼Œå¡«å……ç™½è‰²èƒŒæ™¯
                if (targetMime === 'image/jpeg' || targetMime === 'image/bmp') {
                    ctx.fillStyle = '#FFFFFF'; // ç™½è‰²
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }

                ctx.drawImage(img, 0, 0);
                resolve(canvas.toDataURL(targetMime, 0.9));
            };
            
            reader.readAsDataURL(file);
        });
    }
</script>

</body>
</html>
# 每日免费次数限制（无登录）

## 1. 每人每天 1 次（前端 localStorage）

- **逻辑**：同一浏览器、同一天内只允许成功生成 **1 次**，用 `localStorage` 存 `nano_banana_last_used_date`（日期 YYYY-MM-DD）。
- **记录时机**：只有**生成成功**（拿到图片 URL）后才写入日期，失败/报错不扣次数。
- **优点**：实现简单、对正常用户足够。
- **局限**：用户可通过清除存储、无痕模式、换浏览器/设备绕过，属于「软限制」。

---

## 2. 全站每日生图总次数上限（控制 API 成本）

- **逻辑**：在创建任务接口（`/api/image-to-image`）里，在调用 Kie 前检查「今日已生图次数」；若达到上限则直接返回 429，不扣 Kie 额度。
- **配置**：环境变量 **`NANO_BANANA_DAILY_CAP`** = 每日最多生图次数（正整数）。  
  - 不设或设为 0：不限制。  
  - 例如 `.env.local` 里写 `NANO_BANANA_DAILY_CAP=50`，则全站每天最多 50 次。
- **当前实现**：进程内按自然日计数（`date` + `count`），**重启或换实例会清零**，适合单实例或开发环境。
- **多实例 / 持久化**：若部署为多实例或希望重启后仍生效，需要把「今日次数」存到外部（如 **Cloudflare KV**、**Redis**），在接口里读+原子加 1，再与 `NANO_BANANA_DAILY_CAP` 比较。前端已处理 429，会展示「今日全站生图次数已达上限，请明天再试。」

---

## 3. 可选：按 IP 每人每天 1 次（更强限制）

不做登录时，可再加一层**按 IP 的每日限流**（见上：用 KV/数据库存 `IP -> 最后使用日期`，后端在创建任务前检查）。前端保留现有 localStorage，后端以 IP 为准。

name: Pre-Deploy Check

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  check:
    name: Build & Lint Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check Next.js config
        run: |
          echo "检查 next.config.js..."
          if ! grep -q "output: 'export'" next.config.js; then
            echo "❌ 错误: next.config.js 中缺少 output: 'export'"
            exit 1
          fi
          if ! grep -q "unoptimized: true" next.config.js; then
            echo "⚠️  警告: next.config.js 中建议设置 images.unoptimized: true"
          fi
          echo "✅ Next.js 配置检查通过"

      - name: Check for middleware
        run: |
          echo "检查 middleware.ts..."
          if [ -f "middleware.ts" ]; then
            echo "❌ 错误: 检测到 middleware.ts，静态导出不支持 middleware"
            exit 1
          fi
          echo "✅ Middleware 检查通过"

      - name: Lint
        run: npm run lint
        continue-on-error: true

      - name: Build
        run: npm run build
        env:
          NODE_ENV: production

      - name: Check build output
        run: |
          if [ ! -d "out" ]; then
            echo "❌ 错误: 构建输出目录 'out' 不存在"
            exit 1
          fi
          if [ -z "$(ls -A out)" ]; then
            echo "❌ 错误: out 目录为空"
            exit 1
          fi
          echo "✅ 构建输出检查通过"

      - name: Summary
        run: |
          echo "✅ 所有检查通过！可以安全部署到 Cloudflare Pages"
